ДЕТАЛЬНЫЙ ПРОТОКОЛ ВЫПОЛНЕНИЯ ПУНКТА 4
Парсинг HTML и контракты данных
Статус
Пункт 4 выполнен и закрыт.
 Модуль парсинга считается финально утверждённым, протестированным и готовым к использованию в Local MVP (пункт 5 плана).
Источник истины:
порядок и статус пунктов — Development_Plan.md;


архитектурные решения и их фиксация — данный протокол.


Зафиксировано:
парсинг является детерминированным;


парсинг не содержит агентной логики;


парсинг не принимает решений об отборе или интерпретации данных;


модуль устойчив к типовым изменениям HTML и ошибкам структуры.



1. Контракты и модели данных
1.1 Назначение
Контракты данных определяют конституцию результатов парсинга и являются жёстким интерфейсом между:
Fetcher;


Parsing Engine;


Service Layer.


Контракты не зависят от логики Агента и не меняются на последующих этапах без отдельного решения.

1.2 Файл реализации
app/parsing/models.py



1.3 Ключевые решения
Классификация страниц (Enums):
PageType — определяет тип HTML-страницы:


RESUME;


SERP;


LOGIN;


CAPTCHA;


BAN;


NOT_FOUND.


DataQuality — определяет качество результата:


COMPLETE;


PARTIAL;


ERROR.


Полезная нагрузка (Payload DTO):
ResumeDetailData — полная анкета резюме;


ResumePreviewData — краткая карточка для списков;


вложенные DTO для зарплаты, опыта, образования и др.


Контейнер результата (ParsingResult):
разделяет:


метаданные (тип страницы, таймстамп, качество);


полезную нагрузку (payload);


payload может быть объектом или списком;


гарантирует инвариант:


при PageType.BAN / CAPTCHA / LOGIN полезная нагрузка отсутствует.


Валидация:
жёсткая валидация resume_id (alphanumeric);


проверка URL по regex-шаблону Work.ua.



2. Реестр селекторов (конфигурация DOM)
2.1 Назначение
Селекторы вынесены в единый реестр для:
централизованного контроля DOM-зависимостей;


упрощения адаптации при изменениях структуры сайта;


исключения «магических селекторов» в коде парсеров.



2.2 Файл реализации
app/parsing/selectors.py



2.3 Зафиксированные решения
Signatures:
селекторы для определения типа страницы;


сигнатуры для CAPTCHA, LOGIN и BAN;


исключение ложных срабатываний на общих страницах.


SERP-селекторы:
учёт реальных классов карточек;


корректная обработка .card и .card-visited.


Detail-селекторы:
селекторы для всех полей резюме;


для навыков зафиксирован точный DOM-путь, соответствующий реальной структуре.


Основание:
селекторы выведены на основе анализа реальных HTML-фикстур;


структура подтверждена тестами.



3. Базовый движок парсинга (Core Engine)
3.1 Назначение
Core Engine — фундамент всех парсеров.
 Он:
не знает доменной логики;


не принимает решений о значимости данных;


обеспечивает корректную классификацию и подготовку HTML.



3.2 Файл реализации
app/parsing/base.py



3.3 Зафиксированные решения
HTML-разбор:
используется lxml для производительности и стабильности.


Классификация страниц:
автоматическое определение PageType по сигнатурам;


разделение:


SERP;


RESUME;


служебных страниц (LOGIN / CAPTCHA / BAN).


Очистка данных:
нормализация текста;


удаление неразрывных пробелов;


очистка мусорных символов.



4. Парсер списка резюме (SERP)
4.1 Назначение
SERP-парсер отвечает исключительно за извлечение ссылок и превью-данных.
 Он не загружает детальные страницы.

4.2 Файл реализации
app/parsing/serp.py



4.3 Зафиксированные решения
итерация по карточкам внутри контейнера списка;


преобразование относительных ссылок в абсолютные;


устойчивость к:


рекламным блокам;


битым карточкам;


ошибка одной карточки не ломает весь батч.



5. Парсер детального резюме (Detail Parser)
5.1 Назначение
Detail Parser выполняет хирургическое извлечение данных из HTML резюме.
 Это самый сложный и строго ограниченный компонент.

5.2 Файл реализации
app/parsing/resume.py



5.3 Зафиксированные решения
Канонизация URL:
принудительное приведение к виду
 https://www.work.ua/resumes/{id}/;


игнорирование UTM-меток и «грязных» ссылок.


Изоляция области парсинга:
парсинг выполняется строго внутри контейнера резюме;


исключает захват стороннего DOM.


Секционный сканер:
итерация по заголовкам <h2>;


определение контекста по ключевым словам;


извлечение данных между заголовками;


исключение системных блоков («Похожие кандидаты» и т.п.).


Сбор данных:
опыт и образование — списки объектов;


зарплата — из шапки или характеристик;


навыки — по зафиксированному селектору.



6. Итоговая фиксация
Пункт 4 выполнен полностью.


Архитектура парсинга стабильна.


Контракты данных зафиксированы.


Модуль не содержит агентной логики.


Готов к использованию в Local MVP и на последующих этапах без изменений.


Протокол закрыт.