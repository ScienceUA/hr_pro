# ДЕТАЛЬНЫЙ ПРОТОКОЛ ВЫПОЛНЕНИЯ ПУНКТА 5
Локальный оркестратор (Service Layer). Сборка Local MVP

## Статус

Пункт 5 выполнен и закрыт. Local MVP считается полностью собранным и рабочим.

Источник истины:
- порядок и статус пунктов — `docs/00_context/Development_Plan.md`;
- реализационные решения закрытого пункта — этот протокол.

## 1. Назначение Service Layer

Service Layer — детерминированный оркестратор, который:
- объединяет транспорт и парсеры в единый пайплайн;
- управляет порядком шагов;
- обеспечивает троттлинг и safety checks;
- сохраняет артефакты выполнения в JSON/JSONL.

Service Layer не выполняет смысловой анализ и не оценивает кандидатов.

## 2. Генерация поисковых URL (Search URL Builder)

### 2.1 Файл

- `app/services/url_builder.py`

### 2.2 Зафиксированные решения

- Транслитерация: маппинг кириллических названий городов в slug Work.ua; для неизвестных — автотранслитерация.
- Параметризация: поддержка фильтров Work.ua; списки значений кодируются через `+`; составные значения (например язык–уровень) кодируются через дефис.
- Канонизация: нормализация URL (удаление UTM, приведение домена к `www.work.ua`, сортировка query-параметров) для детерминированности и дедупликации.

## 3. Локальный слой хранения (Local Repository)

### 3.1 Файл

- `app/storage/repository.py`

### 3.2 Зафиксированные решения

- Формат хранения: JSONL (newline-delimited JSON).
- Контракт сохранения: репозиторий принимает `ParsingResult`, а не DTO напрямую; извлечение payload происходит внутри репозитория.
- Дедупликация: in-memory множество обработанных `resume_id`; при старте восстанавливается из существующего файла.
- Устойчивость: flush после каждой записи для минимизации потерь при прерывании.

## 4. Оркестрация краулинга (CrawlerService)

### 4.1 Файл

- `app/services/crawler.py`

### 4.2 Зафиксированные решения

- Основной цикл: SERP → parse preview → dedup → detail fetch → parse detail → save.
- Троттлинг: фиксированные задержки между запросами для работы без прокси.
- Safety checks: предварительная классификация страницы; при `BAN`, `CAPTCHA`, `LOGIN` — критическая остановка сессии.
- Ошибки: единичные сбои не ломают весь прогон; пустые ответы fetcher учитываются как ошибки.

## 5. Точка входа и CLI

### 5.1 Файлы

- `main.py`
- `app/transport/fetcher.py`

### 5.2 Зафиксированные решения

- CLI предоставляет управляемый локальный запуск (query/city/pages/out).
- SmartFetcher реализован на базе `requests`, возвращает HTML строкой.
- SmartFetcher не выбрасывает исключения по HTTP-кодам (страницы защиты могут возвращаться с разными кодами); классификация остаётся на стороне парсера.
- В конце выполнения выводится сводка статистики прогона.

## 6. Итоговая фиксация

- Пункт 5 закрыт.
- Local MVP работает end-to-end.
- Контракт Fetcher и контракт ParsingResult соблюдены.
- Любые изменения пункта 5 запрещены без отдельного решения.

Протокол закрыт.
