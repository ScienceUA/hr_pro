ДЕТАЛЬНЫЙ ПРОТОКОЛ ВЫПОЛНЕНИЯ ПУНКТА 3
Resilient HTTP (подготовительный, cloud-ready transport)
Статус
Пункт 3 реализован как подготовительный задел.
 Он НЕ используется в runtime Local MVP (пункт 5 плана).
 Он НЕ является блокером для Local MVP, так как Local MVP использует SmartFetcher по контракту Fetcher.
Источник истины:
порядок, границы и статус пунктов — Development_Plan.md;


детали реализации — данный протокол.


Принципиально зафиксировано:
Local MVP работает без прокси;


Local MVP работает без async-транспорта;


контракт Fetcher является инвариантом проекта;


расширенный транспорт будет подключаться позже, через адаптер, без изменения Service Layer.



1. Фактически реализованный функционал
1.1 HttpClientFactory
Что реализовано:
DI-фабрика для создания httpx.AsyncClient;


внедрён Semaphore для ограничения числа активных клиентов;


добавлен Jitter для рассинхронизации запросов.


Обоснование:
предотвращает перегрузку памяти и файловых дескрипторов при масштабировании;


защищает от синхронных пиков нагрузки в cloud-сценариях.



1.2 ProxyManager
Что реализовано:
механизм ротации прокси из заданного списка;


выдача прокси на уровне логического чанка.


Обоснование:
позволяет менять IP между чанками, а не внутри одного логического шага;


соответствует модели chunk-based обработки в cloud.



1.3 RequestExecutor
Что реализовано:
исполнитель на базе tenacity;


классификация ошибок;


retry-политики в зависимости от типа ошибки.


Обоснование:
обеспечивает устойчивость к временным сбоям сети;


обеспечивает fail-fast поведение при банах и невалидных прокси.



1.4 Иерархия исключений
Что реализовано:
TransientError;


PermanentError;


ProxyBanError;


AuthError.


Обоснование:
позволяет верхнему уровню однозначно понимать:
 «повторить», «остановиться», «в будущем — сменить прокси».



2. Зафиксированные архитектурные решения
2.1 Контракт Fetcher (инвариант проекта)
Интерфейс Fetcher:
вход: URL;


выход: сырой HTML в виде строки.


Инварианты:
Fetcher не возвращает Parser, DTO или ParsingResult;


Fetcher не классифицирует PageType;


Fetcher не принимает доменных решений;


Fetcher — чистый транспортный слой.



2.2 Реализация Fetcher в Local MVP
Эталонная реализация Fetcher на стадии Local MVP:
SmartFetcher;


синхронный;


requests;


без прокси.


Фиксации:
CrawlerService зависит только от интерфейса Fetcher;


замена реализации Fetcher не требует изменения:


Service Layer;


оркестратора;


парсеров.



2.3 Обработка ошибок в Local MVP (без прокси)
Если HTML после парсинга классифицируется как:
PageType.BAN;


PageType.CAPTCHA;


PageType.LOGIN;


→ выполняется critical stop: сессия краула немедленно завершается.
Если:
страница не найдена (404 / 410);


резюме удалено;


→ ошибка фиксируется, обработка продолжается.
Retry и Backoff:
не являются обязательными в Local MVP;


могут отсутствовать полностью.



3. Cloud-ready транспорт (будущее подключение)
3.1 Контракт подключения
В cloud-фазе будет добавлена реализация:
AsyncResilientFetcherAdapter;


async HTTP;


retry / backoff;


ProxyManager;


расширенная классификация ошибок.


При этом строго соблюдается контракт Fetcher:
вход — URL;


выход — строка HTML.



3.2 Инвариант Service Layer
CrawlerService и парсеры не изменяются;


меняется только реализация Fetcher;


подключение производится через DI.


Это ключевая архитектурная гарантия.

4. Контракт ротации (Chunk Lifecycle)
Правило:
1 chunk = 1 HTTP-клиент = 1 прокси.


Пояснение:
ротация прокси и User-Agent происходит только при создании клиента;


пока клиент жив, прокси не меняется;


исключаются нестабильные состояния внутри чанка.



5. Доказательная база
5.1 Очередь и сеть
Доказано:
семафор корректно ограничивает количество активных клиентов;


сетевой стек работает стабильно;


GZIP-ответы корректно обрабатываются;


внешний IP определяется корректно.



5.2 Retry-политики и классификация ошибок
Доказано:
transient-ошибки (500, сетевые сбои) ретраятся ограниченное число раз;


permanent-ошибки (403, dead proxy) не ретраятся;


поведение строго соответствует контракту.



6. Ресурсы и зависимости
Зависимости:
httpx (с поддержкой HTTP/2);


h2;


tenacity.


Созданные модули:
config: settings, headers;


core: иерархия исключений;


execution: http-client factory, proxy manager, executor.



7. Итоговая фиксация
Пункт 3 выполнен корректно.


Реализация не нарушает Local MVP.


Контракт Fetcher сохранён.


Архитектура готова к cloud-этапу.


Подключение будет выполнено только на этапе 7 плана.


Протокол закрыт.