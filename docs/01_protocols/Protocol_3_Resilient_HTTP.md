# ДЕТАЛЬНЫЙ ПРОТОКОЛ ВЫПОЛНЕНИЯ ПУНКТА 3
Resilient HTTP (подготовительный, cloud-ready транспорт)

## Статус

Пункт 3 выполнен и закрыт как **подготовительный задел**.
Данный транспортный слой **не используется** в runtime Local MVP (пункт 5).

Источник истины:
- порядок и статус пунктов — `docs/00_context/Development_Plan.md`;
- архитектурные решения пункта 3 — данный протокол.

Зафиксировано:
- Local MVP работает без прокси;
- Local MVP использует синхронный транспорт SmartFetcher;
- асинхронный resilient-транспорт предназначен для будущих этапов и подключается без изменения Service Layer.

---

## 1. Назначение подготовительного транспорта

Resilient HTTP предназначен для:
- подготовки к cloud-исполнению;
- масштабирования запросов;
- устойчивости к сетевым сбоям и блокировкам.

Он **не предназначен** для:
- использования в Local MVP;
- изменения логики парсинга;
- изменения логики оркестрации.

---

## 2. Инвариант контракта Fetcher

Fetcher — транспортный контракт проекта.

Инварианты:
- Fetcher принимает URL;
- Fetcher возвращает HTML строкой;
- Fetcher не классифицирует тип страницы;
- Fetcher не принимает доменных решений;
- Fetcher не возвращает DTO или ParsingResult.

Контракт Fetcher является **архитектурным инвариантом** проекта.

---

## 3. Реализованные компоненты подготовительного транспорта

### 3.1 HttpClientFactory

Файл:
- `app/execution/http_client.py`

Решения:
- фабрика для создания HTTP-клиентов;
- ограничение числа активных клиентов через семафор;
- внедрение jitter для рассинхронизации запросов.

Назначение:
- защита от перегрузки памяти и дескрипторов;
- подготовка к параллельному выполнению.

---

### 3.2 ProxyManager

Файл:
- `app/execution/proxy_manager.py`

Решения:
- управление пулом прокси;
- выдача прокси на уровне логического чанка.

Назначение:
- изоляция IP в рамках одного чанка;
- подготовка к proxy-aware оркестрации.

---

### 3.3 RequestExecutor

Файл:
- `app/execution/executor.py`

Решения:
- retry-политики;
- классификация ошибок;
- fail-fast поведение при перманентных ошибках.

Назначение:
- устойчивость к transient-сбоям;
- предсказуемое завершение при блокировках.

---

### 3.4 Иерархия исключений

Файл:
- `app/core/exceptions.py`

Решения:
- разделение transient и permanent ошибок;
- отдельные типы для proxy-ban и auth-ошибок.

Назначение:
- однозначные сигналы верхним слоям;
- подготовка к автоматической смене стратегии в будущем.

---

## 4. Контракт жизненного цикла (Chunk Lifecycle)

Инвариант:
- **1 чанк = 1 HTTP-клиент = 1 прокси**.

Пояснение:
- прокси и user-agent фиксируются при создании клиента;
- внутри чанка они не меняются;
- исключаются нестабильные состояния.

---

## 5. Границы ответственности

Resilient HTTP:
- не влияет на логику Service Layer;
- не влияет на парсеры;
- не меняет формат данных.

Подключение происходит **исключительно** через реализацию Fetcher.

---

## 6. Итоговая фиксация

- Пункт 3 закрыт.
- Контракт Fetcher сохранён.
- Подготовительный транспорт не нарушает Local MVP.
- Архитектура готова к cloud-этапу без изменений закрытых пунктов.

Протокол закрыт.