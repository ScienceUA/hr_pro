# 6.1.13 CriteriaBundle/Search Anchors → SearchCommand (Specification)

## Purpose

Этот документ фиксирует **единственный допустимый** способ построения команды поиска `SearchCommand` из результата интерпретации (пункт 6.1).
Цель — убрать неявные решения и догадки: в `SearchCommand.filters` попадает **только то**, что имеет **однозначное** представление в `app/config/workua_filters_map.json`.

Важно:
- 6.1.13 **не изменяет** Local MVP и не вмешивается в пункты 1–5.
- 6.1.13 определяет только контракт и правила маппинга для агента.

---

## Inputs / Outputs

### Input (source)

Источник данных для маппинга:
- `Search Anchors` из `docs/03_agent/6.1_Fixtures.md`
  (в реализации это может быть подмножество `CriteriaBundle`, но в проекте эталоном является формат фикстур).

### Output (target)

`SearchCommand` — структурированная команда, которую агент передаёт в существующий Local MVP (как “black-box запуск”):

- `query_terms: list[str]`
  - список поисковых терминов (из `role_anchors[].query_text`)
- `filters: dict[str, str|int]`
  - только ключи, определённые в `app/config/workua_filters_map.json`
  - значения — только `slug`/`id`, взятые из тех же справочников
- `algorithm_defaults: dict[str, int]`
  - настройки из `workua_filters_map.json.search_algorithm_defaults` (см. правила ниже)
- `meta: dict`
  - `only_new: bool` (если применимо по chat_state/Δdays)
  - `last_run_at: str|null` (из chat_state)
- `post_filters: dict`
  - `must: list[object|str]`
  - `must_not: list[object|str]`
- `semantic_criteria: list[str]`
- `uncertainties: list[str]`
- `notes: list[str]` (опционально; для пояснений решений маппинга)

---

## Normative rules (hard requirements)

### R1. No guessing

Если значение не выражается **однозначно** через `slug` или `id` из `workua_filters_map.json`, то:
- фильтр **НЕ применяется**,
- причина фиксируется в `uncertainties`.

### R2. Filters are only from workua_filters_map.json

`SearchCommand.filters` может содержать **только** следующие верхнеуровневые ключи из `app/config/workua_filters_map.json`:
- `location`
- `categories`
- `languages`
- `gender`
- `age`
- `experience`
- `education`
- `extra_flags`

Любые другие элементы (например `period`, `sort`) **не являются URL-фильтрами** в рамках этого проекта и не должны попадать в `filters`.

### R3. period/sort are not encoded

Поля `period` и `sort`, присутствующие в `6.1_Fixtures.md`, трактуются как:
- “поведение по умолчанию Work.ua” (если `url_param: null`),
- либо как “параметр будущих этапов” (если когда-то будет введён отдельный конфиг),
но **не** кодируются через `workua_filters_map.json` и **не** попадают в `SearchCommand.filters`.

Если в фикстуре указано `period.url_param` (например `"2"`), это значение:
- сохраняется только как пояснение в `notes` (опционально),
- не включается в `filters` (пока нет источника истины в map.json).

### R4. Algorithm defaults are applied deterministically

`SearchCommand.algorithm_defaults` формируется строго из `workua_filters_map.json.search_algorithm_defaults`.

Базовое правило:
- если `search_algorithm_defaults.default_use_only_title_and_synonyms = true`, то по умолчанию включаются:
  - `only_title` (param `snowide` = 1)
  - `include_synonyms` (param `notitle` = 1)

Дополнительное правило (если в интерпретации/фикстуре явно указан “любой из слов / any word”):
- включается профиль `any_word` (набор params из map.json),
- и он имеет приоритет над “only_title+synonyms”.

---

## Mapping rules

Ниже приведён нормативный маппинг из Search Anchors → SearchCommand.

### M1. role_anchors → query_terms

Источник:
- `Search Anchors.role_anchors[].query_text`

Правило:
- каждый `query_text` добавляется в `SearchCommand.query_terms` в исходном порядке.
- дубликаты допускаются только если они различаются текстом; иначе удаляются (нормализация на стороне агента допустима).

### M2. category → filters.categories

Источник:
- `Search Anchors.category[].slug`

Правило:
- для каждого `slug` применяем:
  - `filters["categories"] = <slug>` (если один)
  - или `filters["categories"] = <comma-separated slugs>` (если у вас в Local MVP поддерживается множественный формат в URL)
Если множественный формат **не определён в проекте**, тогда:
- разрешён только один `slug` (первый),
- остальные фиксируются в `uncertainties`.

### M3. location → filters.location

Источник:
- `Search Anchors.location.slug`

Правило:
- `filters["location"] = <slug>`

### M4. language_requirements → filters.languages

Источник:
- `Search Anchors.language_requirements[].language_id`

Правило:
- `filters["languages"] = <id>` (если один)
- если несколько языков:
  - допускается множественный формат только если он определён вашим URL-строителем,
  - иначе применяется первый, остальные → `uncertainties`.

`level` в языке не маппится в URL (в map.json нет уровня) и остаётся как:
- hard constraint или semantic criterion (по правилу 6.1), но не URL-фильтр.

### M5. gender/age/experience/education → соответствующие filters

Эти поля применяются только если в интерпретации (или отдельной фикстуре 6.1) присутствуют значения, которые однозначно соответствуют `workua_filters_map.json`.

Правило (общее):
- если есть `slug` или `id`, совпадающий со справочником:
  - записываем в `filters[<key>] = <slug|id>`
- иначе:
  - не применяем,
  - пишем причину в `uncertainties`.

### M6. extra_flags → filters.extra_flags

Если в интерпретации выделены флаги из набора:
- `student`
- `photo`
- `disability`
- `veteran`

То применяем ключи/значения строго из `workua_filters_map.json.extra_flags`.

Если флаг указан, но отсутствует в map.json:
- не применяем,
- фиксируем `uncertainties`.

---

## only_new (meta rule)

`SearchCommand.meta.only_new = true` допускается только если в `chat_state` присутствует `last_run_at` и в интерпретации явно запрошено “только новые”.

Важно:
- `only_new` не является URL-фильтром в map.json.
- Это мета-правило для агента/оркестратора верхнего уровня.

---

## Traceability rule

Для каждого применённого элемента:
- `query_terms`
- `filters.*`

должно быть объяснение происхождения из `raw_query`:
- либо как `evidence` в фикстуре 6.1,
- либо как строка пояснения в `notes` (минимально допустимо для 6.1.13).

---

## Definition of Done (DoD)

6.1.13 считается завершённым, если:
1) Для каждого сценария в `docs/03_agent/6.1.13_Fixtures.md` сформирован ожидаемый `SearchCommand`.
2) В каждом `SearchCommand.filters` используются только ключи из `workua_filters_map.json`.
3) Все значения фильтров — только `slug/id`, существующие в `workua_filters_map.json`.
4) Ни один фильтр не заполняется “по догадке”; все неопределённости явно записаны в `uncertainties`.
