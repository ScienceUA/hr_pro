# 6.2 Формирование строки поиска и контракт исполнения Local MVP

## Назначение

Этот документ фиксирует:
- какие данные используются для формирования строки поиска Work.ua,
- из каких файлов проекта берутся правила формирования этих данных,
- какие параметры принимает Local MVP,
- какие данные Local MVP **не видит и не обрабатывает**.

Документ описывает **контракт параметров запуска**.
Он не вводит новых классов, DTO или runtime-объектов.

---

## Терминология

**Команда поиска** — это логический контракт набора параметров,
сформированных агентом и передаваемых через CLI в `CrawlerService.run(...)`.

В runtime команда поиска существует **только** как параметры запуска,
а не как объект или структура данных внутри Local MVP.

---

## Источники правил (Source of Truth)

### 1. Правила интерпретации запроса

- файл: `docs/03_agent/6.1_Interpretation.md`  
  определяет:
  - какие элементы извлекаются из пользовательского запроса,
  - что считается role anchors,
  - что может быть поисковым якорем,
  - что считается неопределённостью.

### 2. Правила формирования команды поиска

- файл: `docs/03_agent/6.1.13_CriteriaBundle_to_SearchCommand.md`  
  определяет:
  - какие извлечённые элементы могут участвовать в поиске,
  - как они преобразуются в параметры запуска,
  - какие элементы **запрещено** передавать в Local MVP.

### 3. Допустимые URL-параметры Work.ua

Единственный источник истины для параметров URL:

- файл: `app/config/workua_filters_map.json`

Только параметры, присутствующие в этом файле и имеющие `url_param`,
могут участвовать в формировании строки поиска.

---

## Формирование строки поиска (URL Construction Contract)

### Участвующие данные

#### 1. Поисковые термины (query terms)

Нормативный источник правил:
- `docs/03_agent/6.1_Interpretation.md`
- `docs/03_agent/6.1.13_CriteriaBundle_to_SearchCommand.md`

Смысл:
- агент формирует список текстовых поисковых якорей (role anchors),
  извлечённых из пользовательского запроса;
- эти якори предназначены **исключительно** для текстового поиска.

Правила исполнения:
- значения используются **как сформированы агентом**;
- порядок сохраняется;
- нормализация, расширение, подстановка синонимов
  **запрещены** на стороне исполнения (CLI / Service Layer / Local MVP runtime).

---

#### 2. URL-фильтры

Источник допустимых фильтров:
- файл: `app/config/workua_filters_map.json`

Допустимые группы фильтров:
- `location`
- `categories`
- `languages`
- `gender`
- `age`
- `experience`
- `education`
- `extra_flags`

Правила:
- используется только `slug` или `id`,
  реально присутствующий в соответствующем справочнике;
- фильтр кодируется в URL **только если**:
  - он присутствует в map-файле,
  - и имеет поле `url_param`.

Если значение не найдено в справочнике:
- фильтр **не применяется**,
- решение фиксируется агентом как неопределённость,
- Local MVP об этом не знает.

---

#### 3. Алгоритмические параметры поиска

Источник:
- файл: `app/config/workua_filters_map.json`
- раздел: `search_algorithm_defaults`

Назначение:
- управление поведением поиска (например, поиск только по заголовкам,
  использование синонимов).

Правила:
- используются **только** параметры, описанные в этом разделе;
- параметр кодируется в URL **только если** у него есть `url_param`;
- если `url_param` отсутствует:
  - параметр не участвует в URL,
  - считается внутренней настройкой алгоритма поиска.

---

### Данные, исключённые из URL

Следующие данные **никогда** не участвуют в формировании строки поиска:

- обязательные требования, не выражаемые через URL,
- исключения (`must_not`),
- semantic-критерии,
- неопределённости,
- пояснения и комментарии.

Эти данные используются **только после получения результатов поиска**.

---

### period / sort

Если в интерпретации запроса присутствуют поля `period` или `sort`,
и при этом они не имеют `url_param` в `app/config/workua_filters_map.json`,
то:

- они **не кодируются** в URL,
- трактуются как:
  - поведение Work.ua по умолчанию,
  - либо параметры будущих этапов проекта.

---

## Контракт исполнения Local MVP

### CLI (`main.py`)

CLI обязан:
- принимать параметры запуска, сформированные агентом,
- передавать их в `CrawlerService.run(...)` **без изменений**.

CLI запрещено:
- добавлять собственные значения по умолчанию,
- изменять или интерпретировать параметры,
- принимать решения о релевантности.

---

### `CrawlerService.run(...)`

`CrawlerService.run(...)`:
- принимает параметры запуска,
- использует их только для:
  - построения URL,
  - управления количеством страниц и лимитами,
- выполняет HTTP-запросы и парсинг.

`CrawlerService` не знает и не должен знать:
- о логике интерпретации запроса,
- о semantic-критериях,
- о правилах отбора или ранжирования.

---

## Архитектурные инварианты (6.2)

Нарушением архитектуры считается:
- использование параметров, отсутствующих в `app/config/workua_filters_map.json`,
- применение фильтров без `url_param`,
- модификация параметров после формирования агентом,
- любая интерпретация смысла запроса на стороне исполнения.

---

## Definition of Done (6.2)

Пункт 6.2 считается завершённым, если:
1. Любая строка поиска однозначно трассируется к:
   - правилам 6.1 и 6.1.13,
   - `app/config/workua_filters_map.json`.
2. Local MVP исполняет поиск детерминированно.
3. Агентная логика полностью отделена от исполнения.
