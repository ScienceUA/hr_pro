# 6.2 Формирование строки поиска и контракт исполнения Local MVP

## Назначение

Этот документ фиксирует:
- какие данные используются для формирования строки поиска Work.ua,
- из каких файлов проекта берутся правила формирования этих данных,
- какие параметры принимает Local MVP,
- какие данные Local MVP **не видит и не обрабатывает**.

Документ описывает **контракт параметров запуска** в виде
согласованного набора аргументов функции `CrawlerService.run(...)`.

Документ **не вводит**:
- классов,
- DTO,
- моделей,
- структур данных,
которые должны существовать в runtime Local MVP.

---

## Терминология

**Команда поиска** — это *условное обозначение* набора параметров запуска,
которые агент формирует и передаёт через CLI в `CrawlerService.run(...)`.

В runtime Local MVP:
- команда поиска существует **только** как аргументы функции,
- не существует объекта, структуры или модели команды поиска.

---

## Источники правил (Source of Truth)

### 1. Правила интерпретации пользовательского запроса

- файл: `docs/03_agent/6.1_Interpretation.md`

Определяет:
- какие элементы извлекаются из пользовательского запроса,
- что считается поисковыми якорями (role anchors),
- что относится к неопределённостям.

---

### 2. Правила преобразования интерпретации в параметры запуска

- файл: `docs/03_agent/6.1.13_CriteriaBundle_to_SearchCommand.md`

Определяет:
- какие извлечённые элементы могут участвовать в формировании параметров,
- какие элементы **запрещено** передавать в Local MVP,
- какие элементы остаются для последующей обработки.

---

### 3. Допустимые URL-параметры Work.ua

Единственный источник истины для URL-параметров поиска:

- файл: `app/config/workua_filters_map.json`

Только параметры:
- присутствующие в этом файле,
- и имеющие `url_param`,
могут участвовать в формировании строки поиска.

---

## Формирование строки поиска (URL Construction Contract)

### Участвующие данные

### 1. Поисковые термины (query)

Нормативный источник правил:
- `docs/03_agent/6.1_Interpretation.md`
- `docs/03_agent/6.1.13_CriteriaBundle_to_SearchCommand.md`

Смысл:
- агент формирует текстовую строку поиска (`query`)
  из пользовательского запроса,
- строка предназначена **исключительно** для текстового поиска резюме.

Правила исполнения:
- значение используется **как сформировано агентом**,
- нормализация, расширение, подстановка синонимов
  **запрещены** на стороне исполнения
  (CLI / Service Layer / Local MVP runtime).

---

### 2. URL-фильтры (params)

Источник допустимых фильтров:
- файл: `app/config/workua_filters_map.json`

`params` — это словарь **сырых URL-параметров Work.ua**.

Допустимые группы параметров:
- `category`
- `experience`
- `language`
- `student`
- `salary`
- `sort`
- и другие, реально поддерживаемые Work.ua.

Правила:
- ключи и значения передаются **без трансформаций**,
- используются только `id` или `slug`,
  реально присутствующие в справочниках Work.ua.

Запрещено:
- использовать Pydantic-имена (`category_ids`, `student_only` и т.п.),
- вводить логические или агрегированные поля.

Если параметр не найден в справочнике:
- он **не передаётся** в Local MVP,
- решение фиксируется агентом как неопределённость.

---

### 3. Алгоритмические параметры поиска

Источник:
- файл: `app/config/workua_filters_map.json`
- раздел: `search_algorithm_defaults`

Правила:
- используются только параметры, описанные в этом разделе,
- параметр кодируется в URL **только если** имеет `url_param`,
- при отсутствии `url_param`:
  - параметр не участвует в URL,
  - считается внутренней настройкой алгоритма.

---

### Параметры period / sort

Параметр `sort` **разрешён** внутри словаря `params`.

Обоснование:
- `UrlBuilder` поддерживает кодирование `sort`,
- отсутствие `sort` в моделях не является ограничением.

Это допустимое упрощение (hack) для Local MVP.

Если параметр не имеет `url_param` в
`app/config/workua_filters_map.json`,
он не кодируется в URL.

---

## Эталон агентного payload (до распаковки в CLI)

Агент обязан формировать параметры запуска
в следующем **плоском виде**:

```json
{
  "query": "Project Manager",
  "city": "kyiv",
  "params": {
    "category": [1],
    "experience": [164, 165],
    "student": 1,
    "sort": "2"
  },
  "max_pages": 3,
  "out_path": "results.jsonl"
}
