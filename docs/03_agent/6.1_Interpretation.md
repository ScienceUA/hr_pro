# 6.1 Интерпретация запроса (Specification)

## 6.1.1 Вход и границы ответственности

**Вход:**  
`raw_query` — текст вакансии или пользовательского запроса в свободной форме  
(абзацы, списки, копипаста вакансии, смешение языков допускаются).

**Контекст:**  
В рамках одного чата существует единый контекст вакансии.

**Запрещено в 6.1:**
- использовать результаты парсинга, хранилища, Service Layer или Fetcher (пункты 1–5);
- использовать историю чата как источник требований (кроме `last_run_at`);
- дополнять требования логическими предположениями.

**Принцип:**  
Если требование:
- не указано явно, или
- указано как необязательное (“желательно”, “будет плюсом”, “nice to have”),
оно **не считается обязательным**.

---

## 6.1.2 Выход (CriteriaBundle)

Результат 6.1 — `CriteriaBundle`, состоящий из:

1) **search_filters**  
→ все **обязательные** требования вакансии,  
→ которые **однозначно сопоставимы** с `workua_filters_map.json`,  
→ и потому **могут и должны** быть закодированы в URL Work.ua.

2) **hard_constraints**  
→ обязательные требования вакансии,  
→ которые **НЕ сопоставимы** с картой Work.ua,  
→ но являются бинарными (“да / нет”).

3) **semantic_criteria**  
→ все требования, которые:
- не обязательны по смыслу, **или**
- обязательны, но **не поддаются URL-кодированию**, **или**
- сформулированы неоднозначно.

4) **chat_state**  
→ состояние чата для повторных запусков.

5) **uncertainties**  
→ всё, что мешает однозначно интерпретировать или закодировать требования.

---

## 6.1.3 Классификация требований вакансии

Каждое извлечённое требование классифицируется по двум осям:

### Ось 1. Обязательность
Требование считается **обязательным**, если:
- в вакансии используются маркеры:
  - “обов’язково”, “обязательно”, “must”, “required”,
  - “не розглядаємо без”, “строго”,
  - или требование сформулировано как базовое условие допуска;
- или требование следует из сути вакансии (например: “офісний бухгалтер” → не удалёнка).

Все остальные формулировки считаются **необязательными**.

### Ось 2. Сопоставимость с Work.ua
Требование считается **сопоставимым**, если:
- оно имеет явное представление в `workua_filters_map.json`,
- и может быть выражено через:
  - `slug`,
  - `id`,
  - параметр URL.

## 6.1.4 Правило формирования search_filters (ключевое)

`search_filters` — это подмножество извлечённых критериев, которое агент имеет право пытаться выразить через URL-фильтры Work.ua.

**Нормативное правило:**
Критерий может быть включён в `search_filters` только если одновременно выполнены условия:

1) Критерий относится к одному из справочников `app/config/workua_filters_map.json`:
   - location
   - categories
   - languages
   - gender
   - age
   - experience
   - education
   - extra_flags

2) Для критерия существует **однозначное** представление в `workua_filters_map.json`:
   - `slug` или `id` из соответствующего справочника,
   - и это значение можно детерминированно закодировать в URL-параметр.

3) Если для критерия нет однозначного `slug/id` (или значение не найдено в справочнике),
   то критерий:
   - **не включается** в `search_filters`,
   - и фиксируется в `uncertainties`.

**Прямой запрет на догадки:**
Если пользователь указал критерий “в общем виде” (например, зарплата без валюты/периода, “любой город”, “английский хороший”, “опыт большой”),
то до появления однозначного кодируемого значения:
- URL-фильтр не применяется,
- сохраняется неопределённость.

**Терминология фикстур:**
`Expected Search Anchors` в `docs/03_agent/6.1_Fixtures.md` является эталонным представлением результата 6.1.
Поля `role_anchors/category/location/language_requirements` соответствуют данным, необходимым для построения команды поиска (см. 6.1.13).
